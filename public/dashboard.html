<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSUB Sales Intelligence Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&family=Source+Serif+4:wght@400;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --green-900: #0e2620;
  --green-800: #1a3c34;
  --green-700: #245a4e;
  --green-600: #2d7368;
  --green-500: #38917f;
  --green-400: #4db89e;
  --green-300: #7dd4bf;
  --green-200: #b5e8d9;
  --green-100: #e0f5ef;
  --green-50: #f0faf6;
  --gold: #c9a84c;
  --gold-light: #e8d48b;
  --red: #e74c3c;
  --orange: #f39c12;
  --blue: #3498db;
  --fresh: #27ae60;
  --active-blue: #2980b9;
  --urgent: #f1c40f;
  --critical: #e74c3c;
  --bg: #f4f6f5;
  --card: #ffffff;
  --text: #1a1a1a;
  --text-secondary: #5a6b65;
  --border: #e0e5e3;
  --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.04);
  --shadow-lg: 0 4px 24px rgba(0,0,0,.1);
  --radius: 12px;
  --radius-sm: 8px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Source Sans 3',sans-serif; background:var(--bg); color:var(--text); font-size:14px; line-height:1.5; }
h1,h2,h3,h4 { font-family:'Source Serif 4',serif; }
.mono { font-family:'IBM Plex Mono',monospace; }

.header { background: linear-gradient(135deg, var(--green-900) 0%, var(--green-800) 100%); color:#fff; padding:0 32px; height:64px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; box-shadow:0 2px 12px rgba(0,0,0,.2); }
.header-left { display:flex; align-items:center; gap:20px; }
.logo { font-family:'Source Serif 4',serif; font-size:28px; font-weight:700; letter-spacing:2px; color:var(--gold); }
.logo-sub { font-size:13px; color:var(--green-300); font-weight:300; letter-spacing:.5px; border-left:1px solid var(--green-600); padding-left:16px; }
.header-right { display:flex; align-items:center; gap:16px; }
.lang-toggle { display:flex; background:var(--green-700); border-radius:20px; overflow:hidden; }
.lang-btn { padding:5px 14px; font-size:12px; font-weight:600; cursor:pointer; border:none; background:transparent; color:var(--green-300); transition:.2s; }
.lang-btn.active { background:var(--green-500); color:#fff; }
.user-area { display:flex; align-items:center; gap:10px; padding:6px 14px; background:var(--green-700); border-radius:20px; font-size:13px; }
.user-avatar { width:28px; height:28px; border-radius:50%; background:var(--gold); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; color:var(--green-900); }

.search-container { padding:20px 32px 0; }
.search-bar { position:relative; max-width:800px; }
.search-bar input { width:100%; padding:14px 20px 14px 52px; border:2px solid var(--border); border-radius:50px; font-size:15px; font-family:'Source Sans 3',sans-serif; background:#fff; transition:.2s; box-shadow:var(--shadow); }
.search-bar input:focus { outline:none; border-color:var(--green-500); box-shadow:0 0 0 4px rgba(56,145,127,.15); }
.search-icon { position:absolute; left:18px; top:50%; transform:translateY(-50%); color:var(--green-600); font-size:18px; }
.ai-badge { position:absolute; right:14px; top:50%; transform:translateY(-50%); background:linear-gradient(135deg,var(--green-600),var(--green-400)); color:#fff; padding:4px 12px; border-radius:20px; font-size:11px; font-weight:600; letter-spacing:.5px; }

.main { padding:20px 32px 40px; }
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
.grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:20px; }
.full-width { margin-bottom:20px; }

.card { background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:24px; transition:box-shadow .2s; }
.card:hover { box-shadow:var(--shadow-lg); }
.card-title { font-size:13px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px; margin-bottom:16px; display:flex; align-items:center; justify-content:space-between; }
.card-title .icon { font-size:16px; }

.kpi-row { display:grid; grid-template-columns:repeat(5,1fr); gap:16px; margin-bottom:20px; }
.kpi { background:var(--card); border-radius:var(--radius); padding:20px 24px; box-shadow:var(--shadow); position:relative; overflow:hidden; transition:.2s; cursor:default; }
.kpi:hover { transform:translateY(-2px); box-shadow:var(--shadow-lg); }
.kpi::after { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg,var(--green-600),var(--green-400)); }
.kpi-label { font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:.8px; font-weight:600; margin-bottom:6px; }
.kpi-value { font-family:'IBM Plex Mono',monospace; font-size:32px; font-weight:500; color:var(--green-800); }
.kpi-change { font-size:12px; color:var(--fresh); margin-top:4px; }

.pipeline { display:flex; align-items:center; gap:0; margin:12px 0; }
.pipeline-step { flex:1; text-align:center; padding:16px 8px; background:var(--green-100); position:relative; cursor:default; transition:.2s; }
.pipeline-step:first-child { border-radius:var(--radius-sm) 0 0 var(--radius-sm); }
.pipeline-step:last-child { border-radius:0 var(--radius-sm) var(--radius-sm) 0; }
.pipeline-step:hover { background:var(--green-200); }
.pipeline-step .step-count { font-family:'IBM Plex Mono',monospace; font-size:28px; font-weight:500; color:var(--green-800); }
.pipeline-step .step-label { font-size:11px; color:var(--text-secondary); margin-top:4px; font-weight:600; text-transform:uppercase; letter-spacing:.3px; }
.pipeline-arrow { width:24px; height:24px; color:var(--green-400); flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:18px; }
.pipeline-step:nth-child(odd) { background:var(--green-50); }
.pipeline-bar { height:4px; background:var(--green-200); border-radius:2px; margin-top:8px; }
.pipeline-bar-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--green-600),var(--green-400)); transition:width .6s ease; }

.toolbar { display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
.filter-btn { padding:7px 16px; border:1.5px solid var(--border); border-radius:20px; font-size:12px; font-weight:600; cursor:pointer; background:#fff; color:var(--text-secondary); transition:.2s; font-family:'Source Sans 3',sans-serif; }
.filter-btn:hover { border-color:var(--green-500); color:var(--green-700); }
.filter-btn.active { background:var(--green-800); color:#fff; border-color:var(--green-800); }
.sort-btn { padding:7px 16px; border:1.5px solid var(--gold); border-radius:20px; font-size:12px; font-weight:600; cursor:pointer; background:transparent; color:var(--gold); transition:.2s; font-family:'Source Sans 3',sans-serif; }
.sort-btn:hover, .sort-btn.active { background:var(--gold); color:var(--green-900); }
.toolbar-spacer { flex:1; }

.table-wrap { overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:13px; }
th { text-align:left; padding:10px 12px; font-size:11px; text-transform:uppercase; letter-spacing:.8px; color:var(--text-secondary); border-bottom:2px solid var(--border); cursor:pointer; white-space:nowrap; font-weight:700; user-select:none; }
th:hover { color:var(--green-700); }
td { padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:middle; }
tr { transition:background .15s; cursor:pointer; }
tbody tr:hover { background:var(--green-50); }
.relevance { padding:3px 10px; border-radius:12px; font-size:11px; font-weight:700; display:inline-block; }
.relevance-high { background:#dcf5e7; color:#1a7a3a; }
.relevance-med { background:#fef3cd; color:#856404; }
.relevance-low { background:#f0f0f0; color:#666; }
.urgency { width:10px; height:10px; border-radius:50%; display:inline-block; }
.urgency-fresh { background:var(--fresh); }
.urgency-active { background:var(--active-blue); }
.urgency-urgent { background:var(--urgent); }
.urgency-critical { background:var(--critical); }
.status { padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; display:inline-block; }
.status-ny { background:#e8f4fd; color:#2980b9; }
.status-behandling { background:#fef3cd; color:#856404; }
.status-tilbudt { background:#e8daef; color:#6c3483; }
.status-vunnet { background:#dcf5e7; color:#1a7a3a; }
.status-tapt { background:#fde8e8; color:#c0392b; }
.handler { font-size:11px; color:var(--text-secondary); }

/* DONUT CHARTS */
.donut-container { display:flex; align-items:center; gap:16px; flex:1; }
.donut-svg { width:140px; height:140px; flex-shrink:0; }
.donut-legend { display:flex; flex-direction:column; gap:5px; }
.donut-legend-item { display:flex; align-items:center; gap:8px; font-size:12px; }
.donut-legend-color { width:10px; height:10px; border-radius:2px; flex-shrink:0; }
.donut-legend-value { font-family:'IBM Plex Mono',monospace; font-weight:600; margin-left:auto; padding-left:8px; }

/* TREND LINE */
.trend-chart { position:relative; height:160px; display:flex; align-items:flex-end; }
.trend-svg { width:100%; overflow:visible; }

/* VISUAL OVERVIEW */
.visual-overview { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-bottom:20px; align-items:stretch; }
.visual-overview .card { padding:16px; display:flex; flex-direction:column; overflow:hidden; min-height:0; }
.visual-overview .card .card-title { margin-bottom:8px; flex-shrink:0; }
.visual-overview .card .donut-container { flex:1; min-height:0; }
.visual-overview .card .trend-svg { flex:1; min-height:0; }

/* COMPANY SECTIONS */
.company-grid { display:grid; gap:12px; }
.company-grid-primary { grid-template-columns:repeat(4,1fr); }
.company-grid-secondary { grid-template-columns:repeat(4,1fr); }
.company-grid-tertiary { grid-template-columns:repeat(3,1fr); }

.company-card { border-radius:var(--radius-sm); padding:16px; display:flex; flex-direction:column; align-items:center; text-align:center; transition:.2s; cursor:default; position:relative; }
.company-card:hover { transform:translateY(-2px); }

/* Primary - Installasjonsselskaper */
.company-card-primary { background:linear-gradient(135deg,var(--green-50),#fff); border:2px solid var(--green-200); box-shadow:var(--shadow); }
.company-card-primary:hover { border-color:var(--green-400); box-shadow:var(--shadow-lg); }
.company-card-primary .company-name { font-size:14px; font-weight:700; color:var(--green-800); margin-bottom:4px; }
.company-card-primary .company-count { font-family:'IBM Plex Mono',monospace; font-size:22px; font-weight:600; color:var(--green-700); }
.company-card-primary .company-label { font-size:10px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:.5px; }
.company-card-primary .company-bar { width:100%; height:4px; background:var(--green-100); border-radius:2px; margin-top:8px; }
.company-card-primary .company-bar-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--green-600),var(--green-400)); }

/* Secondary - FEED */
.company-card-secondary { background:#fff; border:1.5px solid var(--border); box-shadow:0 1px 3px rgba(0,0,0,.04); padding:12px; }
.company-card-secondary:hover { border-color:var(--green-300); }
.company-card-secondary .company-name { font-size:13px; font-weight:600; color:var(--green-700); margin-bottom:2px; }
.company-card-secondary .company-count { font-family:'IBM Plex Mono',monospace; font-size:18px; font-weight:600; color:var(--green-600); }
.company-card-secondary .company-label { font-size:10px; color:var(--text-secondary); }

/* Tertiary - Operat√∏rer */
.company-card-tertiary { background:var(--green-50); border:1px solid var(--border); padding:10px 12px; flex-direction:row; justify-content:space-between; gap:8px; }
.company-card-tertiary .company-name { font-size:12px; font-weight:600; color:var(--text-secondary); }
.company-card-tertiary .company-count { font-family:'IBM Plex Mono',monospace; font-size:14px; font-weight:500; color:var(--text-secondary); }

.section-header { display:flex; align-items:center; gap:10px; margin-bottom:14px; }
.section-header h3 { font-size:16px; color:var(--green-800); }
.section-header-sub { font-size:12px; color:var(--text-secondary); font-style:italic; }
.section-badge { font-size:10px; padding:3px 10px; border-radius:12px; font-weight:600; text-transform:uppercase; letter-spacing:.5px; }

/* BAR CHARTS */
.bar-chart { display:flex; align-items:flex-end; gap:8px; height:160px; padding-top:8px; }
.bar { border-radius:4px 4px 0 0; transition:height .6s ease; cursor:default; position:relative; min-width:28px; }
.bar:hover { opacity:.85; }
.bar-label { position:absolute; bottom:-22px; left:50%; transform:translateX(-50%); font-size:10px; color:var(--text-secondary); white-space:nowrap; }
.bar-value { position:absolute; top:-20px; left:50%; transform:translateX(-50%); font-size:11px; font-weight:600; color:var(--text); font-family:'IBM Plex Mono',monospace; }

.h-bar-chart { display:flex; flex-direction:column; gap:10px; }
.h-bar-row { display:flex; align-items:center; gap:12px; }
.h-bar-label { width:140px; font-size:12px; font-weight:600; text-align:right; white-space:nowrap; }
.h-bar-track { flex:1; height:24px; background:var(--green-50); border-radius:4px; overflow:hidden; }
.h-bar-fill { height:100%; border-radius:4px; background:linear-gradient(90deg,var(--green-700),var(--green-400)); transition:width .8s ease; display:flex; align-items:center; justify-content:flex-end; padding-right:8px; }
.h-bar-fill span { font-size:11px; font-weight:600; color:#fff; font-family:'IBM Plex Mono',monospace; }

/* MAP */
.world-map { position:relative; height:280px; background:var(--green-50); border-radius:var(--radius-sm); overflow:hidden; }
.map-bubble { position:absolute; border-radius:50%; background:rgba(56,145,127,.2); border:2px solid var(--green-500); display:flex; align-items:center; justify-content:center; flex-direction:column; cursor:default; transition:.2s; }
.map-bubble:hover { transform:scale(1.1); background:rgba(56,145,127,.3); }
.map-bubble .pct { font-family:'IBM Plex Mono',monospace; font-size:16px; font-weight:500; color:var(--green-800); }
.map-bubble .region-name { font-size:9px; font-weight:700; color:var(--green-700); text-transform:uppercase; letter-spacing:.5px; }

/* DEPTH */
.depth-chart { display:grid; grid-template-columns:repeat(12,1fr); gap:4px; height:140px; align-items:flex-end; }
.depth-bar { border-radius:3px 3px 0 0; transition:height .6s ease; position:relative; cursor:default; min-height:12px; }
.depth-bar:hover { opacity:.8; }
.depth-label { position:absolute; bottom:-30px; left:50%; transform:translateX(-50%) rotate(-45deg); font-size:9px; color:var(--text-secondary); white-space:nowrap; transform-origin:top left; }
.depth-value { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:10px; font-family:'IBM Plex Mono',monospace; color:var(--text); }

/* TIMELINE */
.timeline { display:flex; align-items:center; gap:0; overflow-x:auto; padding:20px 0 40px; position:relative; }
.timeline::before { content:''; position:absolute; top:50%; left:24px; right:24px; height:3px; background:var(--green-200); border-radius:2px; transform:translateY(-8px); }
.timeline-month { flex:1; min-width:90px; text-align:center; position:relative; z-index:1; }
.timeline-month .month-label { font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:16px; }
.timeline-dot { width:16px; height:16px; border-radius:50%; background:var(--green-500); margin:0 auto; position:relative; z-index:1; border:3px solid #fff; box-shadow:0 0 0 2px var(--green-400); transition:.2s; }
.timeline-dot:hover { transform:scale(1.3); box-shadow:0 0 0 3px var(--green-500); }
.timeline-dot.empty { background:var(--green-200); box-shadow:none; border-color:var(--green-100); }
.timeline-count { font-size:11px; font-family:'IBM Plex Mono',monospace; margin-top:12px; color:var(--text-secondary); font-weight:500; }

/* NEWS */
.news-item { padding:14px 0; border-bottom:1px solid var(--border); display:flex; gap:12px; }
.news-item:last-child { border-bottom:none; }
.news-tag { padding:2px 8px; border-radius:10px; font-size:10px; font-weight:700; text-transform:uppercase; white-space:nowrap; flex-shrink:0; margin-top:2px; }
.news-tag-high { background:#dcf5e7; color:#1a7a3a; }
.news-tag-med { background:#fef3cd; color:#856404; }
.news-content { flex:1; }
.news-title { font-weight:600; font-size:13px; margin-bottom:2px; }
.news-meta { font-size:11px; color:var(--text-secondary); }

/* DROP ZONE */
.drop-zone { border:2px dashed var(--green-300); border-radius:var(--radius); padding:40px; text-align:center; color:var(--text-secondary); cursor:pointer; transition:.2s; background:var(--green-50); }
.drop-zone:hover, .drop-zone.dragover { border-color:var(--green-500); background:var(--green-100); }
.drop-icon { font-size:40px; margin-bottom:8px; }
.drop-text { font-size:14px; font-weight:600; }
.drop-sub { font-size:12px; margin-top:4px; }

/* FORECAST */
.forecast-chart { height:140px; position:relative; display:flex; align-items:flex-end; gap:6px; padding-bottom:24px; }
.forecast-bar { flex:1; border-radius:3px 3px 0 0; position:relative; transition:height .6s ease; }
.forecast-bar .f-label { position:absolute; bottom:-20px; left:50%; transform:translateX(-50%); font-size:10px; color:var(--text-secondary); }
.forecast-bar .f-value { position:absolute; top:-16px; left:50%; transform:translateX(-50%); font-size:10px; font-family:'IBM Plex Mono',monospace; }

.ai-disclaimer { display:flex; align-items:center; gap:8px; padding:10px 16px; background:var(--green-50); border-radius:var(--radius-sm); border-left:3px solid var(--gold); font-size:12px; color:var(--text-secondary); margin-top:12px; }

/* DRAWER */
.drawer-overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:200; opacity:0; pointer-events:none; transition:opacity .3s; }
.drawer-overlay.open { opacity:1; pointer-events:auto; }
.drawer { position:fixed; top:0; right:0; bottom:0; width:520px; max-width:90vw; background:#fff; z-index:201; transform:translateX(100%); transition:transform .35s cubic-bezier(.4,0,.2,1); box-shadow:-8px 0 32px rgba(0,0,0,.15); overflow-y:auto; }
.drawer.open { transform:translateX(0); }
.drawer-header { padding:20px 24px; background:linear-gradient(135deg,var(--green-900),var(--green-800)); color:#fff; display:flex; justify-content:space-between; align-items:flex-start; position:sticky; top:0; z-index:1; }
.drawer-close { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; padding:4px 8px; border-radius:4px; }
.drawer-close:hover { background:rgba(255,255,255,.15); }
.drawer-body { padding:24px; }
.drawer-section { margin-bottom:20px; }
.drawer-section h4 { font-size:13px; text-transform:uppercase; letter-spacing:.8px; color:var(--text-secondary); margin-bottom:10px; font-family:'Source Sans 3',sans-serif; font-weight:700; }
.drawer-row { display:flex; justify-content:space-between; padding:6px 0; font-size:13px; border-bottom:1px solid var(--border); }
.drawer-row:last-child { border-bottom:none; }
.drawer-label { color:var(--text-secondary); }
.drawer-value { font-weight:600; }

.section-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--green-600); margin-bottom:12px; }

::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--green-300); border-radius:3px; }

@keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
.animate { animation: fadeInUp .5s ease forwards; }
.delay-1 { animation-delay:.05s; }
.delay-2 { animation-delay:.1s; }
.delay-3 { animation-delay:.15s; }
.delay-4 { animation-delay:.2s; }
.delay-5 { animation-delay:.25s; }

/* ====== RESPONSIVE: TABLET (max 1024px) ====== */
@media (max-width: 1024px) {
  .header { padding:0 24px; }
  .search-container { padding:16px 24px 0; }
  .main { padding:16px 24px 32px; }

  .kpi-row { grid-template-columns: repeat(3, 1fr); }
  .visual-overview { grid-template-columns: 1fr 1fr; }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 1fr 1fr; }
  .company-grid-primary { grid-template-columns: repeat(2, 1fr); }
  .company-grid-secondary { grid-template-columns: repeat(2, 1fr); }
  .company-grid-tertiary { grid-template-columns: repeat(2, 1fr); }
  .card { padding:20px; }
}

/* ====== RESPONSIVE: MOBILE (max 768px) ====== */
@media (max-width: 768px) {
  .header { height:auto; padding:12px 16px; flex-direction:column; align-items:flex-start; gap:8px; }
  .header-left { flex-direction:column; align-items:flex-start; gap:4px; }
  .logo-sub { border-left:none; padding-left:0; }
  .header-right { width:100%; justify-content:flex-end; }
  .lang-toggle { display:none; }

  .search-container { padding:12px 16px 0; }
  .search-bar { max-width:100%; }
  .search-bar input { padding:12px 16px 12px 44px; font-size:14px; }
  .ai-badge { padding:3px 8px; font-size:10px; }

  .main { padding:12px 16px 24px; }

  .kpi-row { grid-template-columns: 1fr; gap:12px; }
  .kpi { padding:16px; }
  .kpi-value { font-size:28px; }

  .pipeline { overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:8px; }
  .pipeline-step { min-width:120px; flex-shrink:0; padding:12px 8px; }
  .pipeline-arrow { min-width:20px; flex-shrink:0; }

  .visual-overview { grid-template-columns:1fr; }
  .grid-2 { grid-template-columns:1fr; }
  .grid-3 { grid-template-columns:1fr; }

  .donut-container { flex-direction:column; align-items:center; gap:16px; }
  .donut-svg { width:140px; height:140px; }

  .company-grid-primary { grid-template-columns:1fr; }
  .company-grid-secondary { grid-template-columns:1fr; }
  .company-grid-tertiary { grid-template-columns:1fr; }

  .toolbar { gap:8px; }
  .filter-btn, .sort-btn { padding:10px 16px; font-size:13px; min-height:44px; }
  .table-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  table { min-width:700px; }
  td, th { padding:10px 8px; font-size:12px; }

  #leafletMap { height:300px; }

  .depth-chart { height:100px; margin-bottom:28px; }

  .timeline { padding:16px 0 32px; }
  .timeline-month { min-width:70px; }

  .forecast-chart { height:100px; }

  /* Drawer full-screen on mobile */
  .drawer { width:100%; max-width:100%; }
  .drawer-header { padding:16px; }
  .drawer-body { padding:16px; }
  .drawer-close { font-size:28px; padding:8px 12px; min-width:44px; min-height:44px; }

  .card { padding:16px; border-radius:var(--radius-sm); }

  /* Touch targets */
  .filter-btn, .sort-btn, .lang-btn, .drawer-status-btn, tr { min-height:44px; }
  .news-item { padding:16px 0; }

  /* Prevent horizontal overflow */
  html, body { overflow-x:hidden; }
}

/* ====== RESPONSIVE: SMALL PHONES (max 480px) ====== */
@media (max-width: 480px) {
  .header { padding:10px 12px; }
  .logo { font-size:22px; }
  .logo-sub { font-size:11px; }
  .user-area { padding:4px 10px; font-size:12px; }
  .user-avatar { width:24px; height:24px; font-size:10px; }

  .search-container { padding:8px 12px 0; }
  .main { padding:8px 12px 20px; }

  .kpi-row { gap:8px; }
  .kpi { padding:14px; }
  .kpi-value { font-size:24px; }
  .kpi-label { font-size:11px; }

  .pipeline-step { min-width:100px; }
  .pipeline-step .step-count { font-size:22px; }
  .pipeline-step .step-label { font-size:10px; }

  .card { padding:12px; }
  .card-title { font-size:12px; margin-bottom:12px; }

  .section-header h3 { font-size:14px; }

  .donut-svg { width:120px; height:120px; }

  .drawer-header h3 { font-size:16px; }

  table { min-width:600px; }
  td, th { padding:8px 6px; font-size:11px; }

  #leafletMap { height:260px; }

  .forecast-chart { height:80px; }
  .bar-chart { height:120px; }

  .news-title { font-size:12px; }
  .news-meta { font-size:10px; }

  .drop-zone { padding:24px; }
  .drop-icon { font-size:28px; }
  .drop-text { font-size:13px; }
  .drop-sub { font-size:11px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-left">
    <div class="logo">CSUB</div>
    <div class="logo-sub">Sales Intelligence Platform</div>
  </div>
  <div class="header-right">
    <div class="lang-toggle">
      <button class="lang-btn active" onclick="setLang('no',this)">NO</button>
      <button class="lang-btn" onclick="setLang('en',this)">EN</button>
    </div>
    <div class="user-area">
      <div class="user-avatar">HR</div>
      <span>Helge Rasmussen</span>
    </div>
  </div>
</header>

<!-- SEARCH -->
<div class="search-container">
  <div class="search-bar">
    <span class="search-icon">üîç</span>
    <input type="text" placeholder="S√∏k i kontrakter, prosjekter, nyheter..." id="searchInput" oninput="filterContracts()">
    <span class="ai-badge">‚ú® AI-s√∏k</span>
  </div>
</div>

<div class="main">

<!-- KPI CARDS -->
<div class="kpi-row">
  <div class="kpi animate delay-1">
    <div class="kpi-label">Totale kontrakter</div>
    <div class="kpi-value">247</div>
    <div class="kpi-change">‚Üë 12% vs forrige kvartal</div>
  </div>
  <div class="kpi animate delay-2">
    <div class="kpi-label">Leverand√∏rer</div>
    <div class="kpi-value">38</div>
    <div class="kpi-change">‚Üë 3 nye denne mnd</div>
  </div>
  <div class="kpi animate delay-3">
    <div class="kpi-label">Operat√∏rer</div>
    <div class="kpi-value">24</div>
    <div class="kpi-change">‚Üë 2 nye sist uke</div>
  </div>
  <div class="kpi animate delay-4">
    <div class="kpi-label">H√∏y CSUB-relevans</div>
    <div class="kpi-value">63</div>
    <div class="kpi-change">25.5% av total</div>
  </div>
  <div class="kpi animate delay-5">
    <div class="kpi-label">Regioner</div>
    <div class="kpi-value">5</div>
    <div class="kpi-change">Nordsj√∏en dominerer</div>
  </div>
</div>

<!-- PIPELINE -->
<div class="card full-width">
  <div class="card-title">Salgspipeline <span class="icon">üìä</span></div>
  <div class="pipeline">
    <div class="pipeline-step">
      <div class="step-count">142</div>
      <div class="step-label">FEED</div>
      <div class="pipeline-bar"><div class="pipeline-bar-fill" style="width:100%"></div></div>
    </div>
    <div class="pipeline-arrow">‚Üí</div>
    <div class="pipeline-step">
      <div class="step-count">67</div>
      <div class="step-label">Bud p√• bud</div>
      <div class="pipeline-bar"><div class="pipeline-bar-fill" style="width:47%"></div></div>
    </div>
    <div class="pipeline-arrow">‚Üí</div>
    <div class="pipeline-step">
      <div class="step-count">34</div>
      <div class="step-label">Tildeling</div>
      <div class="pipeline-bar"><div class="pipeline-bar-fill" style="width:24%"></div></div>
    </div>
    <div class="pipeline-arrow">‚Üí</div>
    <div class="pipeline-step">
      <div class="step-count">18</div>
      <div class="step-label">CSUB direkte kontakt</div>
      <div class="pipeline-bar"><div class="pipeline-bar-fill" style="width:13%"></div></div>
    </div>
    <div class="pipeline-arrow">‚Üí</div>
    <div class="pipeline-step">
      <div class="step-count">9</div>
      <div class="step-label">CSUB Contract Award</div>
      <div class="pipeline-bar"><div class="pipeline-bar-fill" style="width:6%"></div></div>
    </div>
  </div>
</div>

<!-- ====== VISUAL OVERVIEW (NEW) ====== -->
<div class="visual-overview">
  <!-- Donut: Phase distribution -->
  <div class="card">
    <div class="card-title">Kontrakter etter fase <span class="icon">üéØ</span></div>
    <div class="donut-container">
      <svg class="donut-svg" viewBox="0 0 160 160">
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-100)" stroke-width="24"/>
        <!-- FEED: 142/270 = 52.6% ‚Üí 330.5 of 628.3 (2œÄr=377) stroke-dasharray -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-700)" stroke-width="24"
          stroke-dasharray="198.3 179" stroke-dashoffset="0" transform="rotate(-90 80 80)" style="transition:stroke-dasharray 1s"/>
        <!-- Bud: 67/270 = 24.8% ‚Üí 93.6 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-500)" stroke-width="24"
          stroke-dasharray="93.6 283.7" stroke-dashoffset="-198.3" transform="rotate(-90 80 80)"/>
        <!-- Tildelt: 34/270 = 12.6% ‚Üí 47.5 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-300)" stroke-width="24"
          stroke-dasharray="47.5 329.8" stroke-dashoffset="-291.9" transform="rotate(-90 80 80)"/>
        <!-- Kontaktet: 18/270 = 6.7% ‚Üí 25.2 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--gold)" stroke-width="24"
          stroke-dasharray="25.2 352.1" stroke-dashoffset="-339.4" transform="rotate(-90 80 80)"/>
        <!-- Award: 9/270 = 3.3% ‚Üí 12.4 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--gold-light)" stroke-width="24"
          stroke-dasharray="12.4 364.9" stroke-dashoffset="-364.6" transform="rotate(-90 80 80)"/>
        <text x="80" y="76" text-anchor="middle" font-family="IBM Plex Mono" font-size="22" font-weight="600" fill="var(--green-800)">270</text>
        <text x="80" y="94" text-anchor="middle" font-family="Source Sans 3" font-size="10" fill="var(--text-secondary)">TOTALT</text>
      </svg>
      <div class="donut-legend">
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--green-700)"></div>FEED<span class="donut-legend-value">142</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--green-500)"></div>Bud<span class="donut-legend-value">67</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--green-300)"></div>Tildelt<span class="donut-legend-value">34</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--gold)"></div>Kontaktet<span class="donut-legend-value">18</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--gold-light)"></div>Award<span class="donut-legend-value">9</span></div>
      </div>
    </div>
  </div>

  <!-- Donut: Regional distribution -->
  <div class="card">
    <div class="card-title">Regional fordeling <span class="icon">üåç</span></div>
    <div class="donut-container">
      <svg class="donut-svg" viewBox="0 0 160 160">
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-100)" stroke-width="24"/>
        <!-- Nordsj√∏en 38% ‚Üí 143.3 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-800)" stroke-width="24"
          stroke-dasharray="143.3 234" stroke-dashoffset="0" transform="rotate(-90 80 80)"/>
        <!-- Brasil 22% ‚Üí 83 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-500)" stroke-width="24"
          stroke-dasharray="83 294.3" stroke-dashoffset="-143.3" transform="rotate(-90 80 80)"/>
        <!-- Vest-Afrika 18% ‚Üí 67.9 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-300)" stroke-width="24"
          stroke-dasharray="67.9 309.4" stroke-dashoffset="-226.3" transform="rotate(-90 80 80)"/>
        <!-- Asia-Pac 12% ‚Üí 45.2 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--gold)" stroke-width="24"
          stroke-dasharray="45.2 332.1" stroke-dashoffset="-294.2" transform="rotate(-90 80 80)"/>
        <!-- GoM 10% ‚Üí 37.7 -->
        <circle cx="80" cy="80" r="60" fill="none" stroke="var(--gold-light)" stroke-width="24"
          stroke-dasharray="37.7 339.6" stroke-dashoffset="-339.4" transform="rotate(-90 80 80)"/>
        <text x="80" y="76" text-anchor="middle" font-family="IBM Plex Mono" font-size="18" font-weight="600" fill="var(--green-800)">5</text>
        <text x="80" y="94" text-anchor="middle" font-family="Source Sans 3" font-size="10" fill="var(--text-secondary)">REGIONER</text>
      </svg>
      <div class="donut-legend">
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--green-800)"></div>Nordsj√∏en<span class="donut-legend-value">38%</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--green-500)"></div>Brasil<span class="donut-legend-value">22%</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--green-300)"></div>Vest-Afrika<span class="donut-legend-value">18%</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--gold)"></div>Asia-Pac<span class="donut-legend-value">12%</span></div>
        <div class="donut-legend-item"><div class="donut-legend-color" style="background:var(--gold-light)"></div>GoM<span class="donut-legend-value">10%</span></div>
      </div>
    </div>
  </div>

  <!-- Trend line -->
  <div class="card">
    <div class="card-title">Kontrakttrend (12 mnd) <span class="icon">üìà</span></div>
    <svg class="trend-svg" viewBox="0 0 300 170" style="flex:1;min-height:0;">
      <!-- Grid lines -->
      <line x1="30" y1="20" x2="290" y2="20" stroke="var(--border)" stroke-width=".5"/>
      <line x1="30" y1="50" x2="290" y2="50" stroke="var(--border)" stroke-width=".5"/>
      <line x1="30" y1="80" x2="290" y2="80" stroke="var(--border)" stroke-width=".5"/>
      <line x1="30" y1="110" x2="290" y2="110" stroke="var(--border)" stroke-width=".5"/>
      <line x1="30" y1="140" x2="290" y2="140" stroke="var(--border)" stroke-width=".5"/>
      <!-- Y labels -->
      <text x="24" y="24" text-anchor="end" font-size="9" fill="var(--text-secondary)" font-family="IBM Plex Mono">40</text>
      <text x="24" y="54" text-anchor="end" font-size="9" fill="var(--text-secondary)" font-family="IBM Plex Mono">30</text>
      <text x="24" y="84" text-anchor="end" font-size="9" fill="var(--text-secondary)" font-family="IBM Plex Mono">20</text>
      <text x="24" y="114" text-anchor="end" font-size="9" fill="var(--text-secondary)" font-family="IBM Plex Mono">10</text>
      <text x="24" y="144" text-anchor="end" font-size="9" fill="var(--text-secondary)" font-family="IBM Plex Mono">0</text>
      <!-- Area fill -->
      <path d="M54,95 L78,89 L102,98 L126,80 L150,74 L174,68 L198,56 L222,50 L246,44 L270,38 L270,140 L54,140 Z"
        fill="url(#trendGrad)" opacity=".3"/>
      <!-- Line -->
      <polyline points="54,95 78,89 102,98 126,80 150,74 174,68 198,56 222,50 246,44 270,38"
        fill="none" stroke="var(--green-500)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- Dots -->
      <circle cx="54" cy="95" r="3" fill="var(--green-600)"/>
      <circle cx="78" cy="89" r="3" fill="var(--green-600)"/>
      <circle cx="102" cy="98" r="3" fill="var(--green-600)"/>
      <circle cx="126" cy="80" r="3" fill="var(--green-600)"/>
      <circle cx="150" cy="74" r="3" fill="var(--green-600)"/>
      <circle cx="174" cy="68" r="3" fill="var(--green-600)"/>
      <circle cx="198" cy="56" r="3" fill="var(--green-600)"/>
      <circle cx="222" cy="50" r="3" fill="var(--green-600)"/>
      <circle cx="246" cy="44" r="3" fill="var(--green-600)"/>
      <circle cx="270" cy="38" r="4" fill="var(--gold)" stroke="var(--green-800)" stroke-width="2"/>
      <!-- X labels -->
      <text x="54" y="155" text-anchor="middle" font-size="8" fill="var(--text-secondary)">Mai</text>
      <text x="102" y="155" text-anchor="middle" font-size="8" fill="var(--text-secondary)">Jul</text>
      <text x="150" y="155" text-anchor="middle" font-size="8" fill="var(--text-secondary)">Sep</text>
      <text x="198" y="155" text-anchor="middle" font-size="8" fill="var(--text-secondary)">Nov</text>
      <text x="246" y="155" text-anchor="middle" font-size="8" fill="var(--text-secondary)">Jan</text>
      <text x="270" y="155" text-anchor="middle" font-size="8" fill="var(--gold)" font-weight="700">Feb</text>
      <defs>
        <linearGradient id="trendGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="var(--green-400)" stop-opacity=".4"/>
          <stop offset="100%" stop-color="var(--green-400)" stop-opacity="0"/>
        </linearGradient>
      </defs>
    </svg>
    <div style="display:flex;justify-content:space-between;margin-top:4px;">
      <span style="font-size:11px;color:var(--text-secondary)">Stigende trend ‚Üó</span>
      <span style="font-size:11px;font-weight:600;color:var(--green-700)">+34% siste 6 mnd</span>
    </div>
  </div>
</div>

<!-- ====== COMPANY SECTIONS (RESTRUCTURED) ====== -->

<!-- INSTALLASJONSSELSKAPER ‚Äî most prominent -->
<div class="card full-width" style="border:2px solid var(--green-200);border-top:4px solid var(--green-600);">
  <div class="section-header">
    <span style="font-size:22px;">üîß</span>
    <h3>Installasjonsselskaper</h3>
    <span class="section-header-sub">‚Äî CSUB sine kunder</span>
    <span class="section-badge" style="background:var(--green-100);color:var(--green-700);margin-left:auto;">8 selskaper</span>
  </div>
  <div class="company-grid company-grid-primary">
    <div class="company-card company-card-primary">
      <div class="company-name">Subsea7</div>
      <div class="company-count">48</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:100%"></div></div>
    </div>
    <div class="company-card company-card-primary">
      <div class="company-name">TechnipFMC</div>
      <div class="company-count">41</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:85%"></div></div>
    </div>
    <div class="company-card company-card-primary">
      <div class="company-name">Saipem</div>
      <div class="company-count">29</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:60%"></div></div>
    </div>
    <div class="company-card company-card-primary">
      <div class="company-name">McDermott</div>
      <div class="company-count">12</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:25%"></div></div>
    </div>
    <div class="company-card company-card-primary">
      <div class="company-name">Allseas</div>
      <div class="company-count">16</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:33%"></div></div>
    </div>
    <div class="company-card company-card-primary">
      <div class="company-name">Ocean Installer</div>
      <div class="company-count">9</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:19%"></div></div>
    </div>
    <div class="company-card company-card-primary">
      <div class="company-name">DOF</div>
      <div class="company-count">18</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:38%"></div></div>
    </div>
    <div class="company-card company-card-primary">
      <div class="company-name">DeepOcean</div>
      <div class="company-count">11</div>
      <div class="company-label">kontrakter</div>
      <div class="company-bar"><div class="company-bar-fill" style="width:23%"></div></div>
    </div>
  </div>
</div>

<!-- FEED-SELSKAPER ‚Äî secondary -->
<div class="grid-2">
  <div class="card">
    <div class="section-header">
      <span style="font-size:18px;">üìê</span>
      <h3 style="font-size:15px;">FEED-selskaper</h3>
      <span class="section-header-sub">‚Äî fremtidige kunder</span>
    </div>
    <div class="company-grid company-grid-secondary">
      <div class="company-card company-card-secondary">
        <div class="company-name">Wood</div>
        <div class="company-count">14</div>
        <div class="company-label">prosjekter</div>
      </div>
      <div class="company-card company-card-secondary">
        <div class="company-name">Worley</div>
        <div class="company-count">12</div>
        <div class="company-label">prosjekter</div>
      </div>
      <div class="company-card company-card-secondary">
        <div class="company-name">Aker Solutions</div>
        <div class="company-count">34</div>
        <div class="company-label">prosjekter</div>
      </div>
      <div class="company-card company-card-secondary">
        <div class="company-name">Petrofac</div>
        <div class="company-count">8</div>
        <div class="company-label">prosjekter</div>
      </div>
      <div class="company-card company-card-secondary">
        <div class="company-name">Genesis Energies</div>
        <div class="company-count">6</div>
        <div class="company-label">prosjekter</div>
      </div>
      <div class="company-card company-card-secondary">
        <div class="company-name">Oceaneering</div>
        <div class="company-count">22</div>
        <div class="company-label">prosjekter</div>
      </div>
      <div class="company-card company-card-secondary">
        <div class="company-name">Trendsetter</div>
        <div class="company-count">5</div>
        <div class="company-label">prosjekter</div>
      </div>
    </div>
  </div>

  <!-- OPERAT√òRSELSKAPER ‚Äî compact/subtle -->
  <div class="card" style="background:var(--green-50);">
    <div class="section-header">
      <span style="font-size:16px;">üè≠</span>
      <h3 style="font-size:14px;color:var(--text-secondary);">Operat√∏rselskaper</h3>
      <span class="section-header-sub">‚Äî bakgrunnsinformasjon</span>
    </div>
    <div class="company-grid company-grid-tertiary">
      <div class="company-card company-card-tertiary"><span class="company-name">Equinor</span><span class="company-count">42</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">Shell</span><span class="company-count">34</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">Petrobras</span><span class="company-count">28</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">TotalEnergies</span><span class="company-count">22</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">BP</span><span class="company-count">18</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">Aker BP</span><span class="company-count">15</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">Chevron</span><span class="company-count">14</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">QatarEnergy</span><span class="company-count">9</span></div>
      <div class="company-card company-card-tertiary"><span class="company-name">ConocoPhillips</span><span class="company-count">12</span></div>
    </div>
  </div>
</div>

<!-- FILTERS & TABLE -->
<div class="card full-width">
  <div class="card-title">Kontraktoversikt <span class="icon">üìã</span></div>
  <div class="toolbar">
    <button class="filter-btn active" onclick="toggleFilter(this,'all')">Alle</button>
    <button class="filter-btn" onclick="toggleFilter(this,'epci')">EPCI</button>
    <button class="filter-btn" onclick="toggleFilter(this,'subsea')">Subsea</button>
    <div class="toolbar-spacer"></div>
    <button class="sort-btn active" id="sortNewest" onclick="toggleSort('newest')">Nyeste f√∏rst</button>
    <button class="sort-btn" id="sortUrgent" onclick="toggleSort('urgent')">Haster mest</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortTable(0)">Dato ‚Üï</th>
          <th onclick="sortTable(1)">Leverand√∏r ‚Üï</th>
          <th onclick="sortTable(2)">Operat√∏r ‚Üï</th>
          <th onclick="sortTable(3)">Prosjektnavn ‚Üï</th>
          <th>CSUB-relevans</th>
          <th>Region</th>
          <th>Land</th>
          <th>Urgency</th>
          <th>Status</th>
          <th>Ansvarlig</th>
        </tr>
      </thead>
      <tbody id="contractTable"></tbody>
    </table>
  </div>
  <div class="ai-disclaimer">
    <span class="ai-icon">ü§ñ</span>
    AI-vurdering, verifiser selv ‚Äî relevansscorer er beregnet av maskinl√¶ring og kan inneholde feil.
  </div>
</div>

<!-- 2-COL: MAP + WATER DEPTH -->
<div class="grid-2">
  <div class="card">
    <div class="card-title">Regioner ‚Äî verdenskart <span class="icon">üåç</span></div>
    <div id="leafletMap" style="height:400px;border-radius:var(--radius-sm);z-index:1;"></div>
  </div>
  <div class="card">
    <div class="card-title">Vanndybde-fordeling <span class="icon">üåä</span></div>
    <div class="depth-chart" id="depthChart" style="margin-bottom:36px;"></div>
  </div>
</div>

<!-- TIMELINE -->
<div class="card full-width">
  <div class="card-title">Tidslinje ‚Äî kontrakttildelinger <span class="icon">üìÖ</span></div>
  <div class="timeline" id="timeline"></div>
</div>

<!-- 2-COL: NEWS + DRAG/DROP -->
<div class="grid-2">
  <div class="card">
    <div class="card-title">Nyhetsstr√∏m ‚Äî AI-kuratert <span class="icon">üì∞</span></div>
    <div id="newsFeed"></div>
  </div>
  <div class="card" style="display:flex;flex-direction:column;">
    <div class="card-title">Dokumentopplasting <span class="icon">üìÑ</span></div>
    <div class="drop-zone" id="dropZone" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
      <div class="drop-icon">üìé</div>
      <div class="drop-text">Slipp dokumenter eller skjermbilder her</div>
      <div class="drop-sub">AI analyserer og kobler til relevante kontrakter</div>
    </div>
  </div>
</div>

<!-- FORECAST -->
<div class="card full-width">
  <div class="card-title">Rystad-prognose ‚Äî Subsea-marked til 2034 <span class="icon">üìà</span></div>
  <div class="forecast-chart" id="forecastChart"></div>
  <div class="ai-disclaimer" style="margin-top:16px;">
    <span class="ai-icon">üìä</span>
    Kilde: Rystad Energy ‚Äî prognose oppdatert Q4 2025
  </div>
</div>

</div><!-- /main -->

<!-- DRAWER -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div>
      <h3 style="font-size:18px;margin-bottom:4px;" id="drawerTitle">Bacalhau Phase 2 ‚Äî SURF</h3>
      <div style="font-size:12px;opacity:.7;" id="drawerSubtitle">Subsea7 ‚Üí Equinor</div>
    </div>
    <button class="drawer-close" onclick="closeDrawer()">√ó</button>
  </div>
  <div class="drawer-body">
    <div class="drawer-section">
      <h4>Kontraktdetaljer</h4>
      <div class="drawer-row"><span class="drawer-label">Dato</span><span class="drawer-value" id="dDate">2025-11-18</span></div>
      <div class="drawer-row"><span class="drawer-label">Leverand√∏r</span><span class="drawer-value" id="dSupplier">Subsea7</span></div>
      <div class="drawer-row"><span class="drawer-label">Operat√∏r</span><span class="drawer-value" id="dOperator">Equinor</span></div>
      <div class="drawer-row"><span class="drawer-label">Region</span><span class="drawer-value" id="dRegion">Brasil</span></div>
      <div class="drawer-row"><span class="drawer-label">Land</span><span class="drawer-value" id="dCountry">Brasil</span></div>
      <div class="drawer-row"><span class="drawer-label">Type</span><span class="drawer-value" id="dType">EPCI</span></div>
      <div class="drawer-row"><span class="drawer-label">Vanndybde</span><span class="drawer-value" id="dDepth">2 100 m</span></div>
      <div class="drawer-row"><span class="drawer-label">Est. verdi</span><span class="drawer-value" id="dValue">$850M</span></div>
    </div>
    <div class="drawer-section">
      <h4>AI-relevansvurdering</h4>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <span class="relevance relevance-high">H√∏y</span>
        <span style="font-size:13px;">Score: <strong class="mono">0.94</strong></span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
        Prosjektet inkluderer subsea-installasjon med behov for spesialverkt√∏y og koblinger som matcher CSUB sitt produktsortiment. H√∏y sannsynlighet for direkte leveranse.
      </div>
      <div class="ai-disclaimer" style="margin-top:12px;">
        <span class="ai-icon">ü§ñ</span>
        AI-vurdering, verifiser selv
      </div>
    </div>
    <div class="drawer-section">
      <h4>Status</h4>
      <div id="drawerStatus" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <button class="drawer-status-btn" onclick="setDrawerStatus(this,'Ny')" style="padding:8px 18px;border:2px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-size:13px;font-weight:600;font-family:'Source Sans 3',sans-serif;transition:.2s;">Ny</button>
        <button class="drawer-status-btn active-status" onclick="setDrawerStatus(this,'Under behandling')" style="padding:8px 18px;border:2px solid var(--green-600);border-radius:8px;background:var(--green-100);cursor:pointer;font-size:13px;font-weight:600;font-family:'Source Sans 3',sans-serif;color:var(--green-800);transition:.2s;">üü¢ Under behandling</button>
        <button class="drawer-status-btn" onclick="setDrawerStatus(this,'Ferdigstilt')" style="padding:8px 18px;border:2px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-size:13px;font-weight:600;font-family:'Source Sans 3',sans-serif;transition:.2s;">Ferdigstilt</button>
        <button class="drawer-status-btn" onclick="setDrawerStatus(this,'Forkastet')" style="padding:8px 18px;border:2px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-size:13px;font-weight:600;font-family:'Source Sans 3',sans-serif;transition:.2s;">Forkastet</button>
      </div>
      <div id="drawerHandler" style="margin-top:12px;font-size:13px;color:var(--text-secondary);">
        Tatt av: <strong style="color:var(--text);">Helge Rasmussen</strong> ¬∑ 2. okt 2025
      </div>
    </div>
    <div class="drawer-section">
      <h4>Dokumenter</h4>
      <div style="font-size:13px;display:flex;flex-direction:column;gap:6px;">
        <a href="#" style="color:var(--green-600);text-decoration:none;">üìÑ Tilbudsdokument_Bacalhau_v3.pdf</a>
        <a href="#" style="color:var(--green-600);text-decoration:none;">üìä Teknisk_spesifikasjon.xlsx</a>
        <a href="#" style="color:var(--green-600);text-decoration:none;">üìß Korrespondanse_Subsea7.eml</a>
      </div>
    </div>
  </div>
</div>

<script>
const contracts = [
  {date:'2026-01-15',supplier:'Subsea7',operator:'Equinor',project:'Irpa Subsea Tieback',relevance:'high',region:'Nordsj√∏en',country:'Norge',type:'subsea',age:28,status:'Under behandling',handler:'Helge R.'},
  {date:'2026-01-08',supplier:'TechnipFMC',operator:'Shell',project:'Jackdaw Phase 2 SURF',relevance:'high',region:'Nordsj√∏en',country:'UK',type:'epci',age:35,status:'Tilbudt',handler:'Helge R.'},
  {date:'2025-12-20',supplier:'Saipem',operator:'Petrobras',project:'B√∫zios 9 FPSO Risers',relevance:'med',region:'Brasil',country:'Brasil',type:'epci',age:54,status:'Ny',handler:'‚Äî'},
  {date:'2025-12-15',supplier:'Subsea7',operator:'TotalEnergies',project:'CLOV Phase 3 Subsea',relevance:'high',region:'Vest-Afrika',country:'Angola',type:'subsea',age:59,status:'Under behandling',handler:'Knut M.'},
  {date:'2025-12-01',supplier:'Aker Solutions',operator:'Equinor',project:'Troll Phase 3 Exp',relevance:'high',region:'Nordsj√∏en',country:'Norge',type:'subsea',age:73,status:'Vunnet',handler:'Helge R.'},
  {date:'2025-11-28',supplier:'TechnipFMC',operator:'BP',project:'Azeri Central East Umbilicals',relevance:'med',region:'Asia-Pac',country:'Aserbajdsjan',type:'subsea',age:76,status:'Tapt',handler:'Helge R.'},
  {date:'2025-11-18',supplier:'Subsea7',operator:'Equinor',project:'Bacalhau Phase 2 SURF',relevance:'high',region:'Brasil',country:'Brasil',type:'epci',age:86,status:'Tilbudt',handler:'Helge R.'},
  {date:'2025-11-05',supplier:'Prysmian',operator:'Aker BP',project:'Yggdrasil Power Cable',relevance:'low',region:'Nordsj√∏en',country:'Norge',type:'epci',age:99,status:'Ny',handler:'‚Äî'},
  {date:'2025-10-22',supplier:'McDermott',operator:'LLOG',project:'Salamanca EPCI',relevance:'med',region:'GoM',country:'USA',type:'epci',age:113,status:'Under behandling',handler:'Knut M.'},
  {date:'2025-10-10',supplier:'Saipem',operator:'ENI',project:'Coral South FLNG Phase 2',relevance:'high',region:'Vest-Afrika',country:'Mosambik',type:'epci',age:125,status:'Ny',handler:'‚Äî'},
  {date:'2025-09-28',supplier:'Subsea Integration Alliance',operator:'Woodside',project:'Scarborough Subsea',relevance:'med',region:'Asia-Pac',country:'Australia',type:'subsea',age:137,status:'Tilbudt',handler:'Helge R.'},
  {date:'2025-09-15',supplier:'TechnipFMC',operator:'Petrobras',project:'Mero 4 Flexible Risers',relevance:'high',region:'Brasil',country:'Brasil',type:'subsea',age:150,status:'Vunnet',handler:'Knut M.'},
  {date:'2025-08-30',supplier:'Oceaneering',operator:'Chevron',project:'Anchor SPS Tooling',relevance:'high',region:'GoM',country:'USA',type:'subsea',age:166,status:'Under behandling',handler:'Helge R.'},
  {date:'2025-08-12',supplier:'DOF Subsea',operator:'ConocoPhillips',project:'Eldfisk IMR Campaign',relevance:'low',region:'Nordsj√∏en',country:'Norge',type:'subsea',age:184,status:'Vunnet',handler:'Knut M.'},
  {date:'2025-07-20',supplier:'Subsea7',operator:'Shell',project:'Bonga North SURF',relevance:'high',region:'Vest-Afrika',country:'Nigeria',type:'epci',age:207,status:'Under behandling',handler:'Helge R.'},
  {date:'2026-02-05',supplier:'Aker Solutions',operator:'Equinor',project:'Wisting Subsea Production',relevance:'high',region:'Nordsj√∏en',country:'Norge',type:'subsea',age:7,status:'Ny',handler:'‚Äî'},
  {date:'2026-02-01',supplier:'TechnipFMC',operator:'TotalEnergies',project:'Kaminho Block 20 SPS',relevance:'med',region:'Vest-Afrika',country:'Angola',type:'subsea',age:11,status:'Under behandling',handler:'Knut M.'},
  {date:'2026-01-25',supplier:'Saipem',operator:'QatarEnergy',project:'North Field South Pipelines',relevance:'low',region:'Asia-Pac',country:'Qatar',type:'epci',age:18,status:'Ny',handler:'‚Äî'},
];

function urgencyClass(age) { if(age<=14) return 'fresh'; if(age<=30) return 'active'; if(age<=60) return 'urgent'; return 'critical'; }
function urgencyLabel(age) { if(age<=14) return 'Fresh'; if(age<=30) return 'Active'; if(age<=60) return 'Urgent'; return 'Critical'; }

let currentFilter='all', currentSort='newest', searchQuery='';
function renderTable() {
  let data = [...contracts];
  if(currentFilter!=='all') data=data.filter(c=>c.type===currentFilter);
  if(searchQuery) { const q=searchQuery.toLowerCase(); data=data.filter(c=>Object.values(c).some(v=>String(v).toLowerCase().includes(q))); }
  if(currentSort==='newest') data.sort((a,b)=>b.date.localeCompare(a.date));
  else data.sort((a,b)=>b.age-a.age);
  const tb=document.getElementById('contractTable');
  tb.innerHTML=data.map(c=>`<tr onclick="openDrawer(${contracts.indexOf(c)})">
    <td class="mono" style="font-size:12px">${c.date}</td>
    <td><strong>${c.supplier}</strong></td>
    <td>${c.operator}</td>
    <td>${c.project}</td>
    <td><span class="relevance relevance-${c.relevance}">${c.relevance==='high'?'H√∏y':c.relevance==='med'?'Medium':'Lav'}</span></td>
    <td>${c.region}</td>
    <td>${c.country}</td>
    <td><span class="urgency urgency-${urgencyClass(c.age)}" title="${urgencyLabel(c.age)} (${c.age}d)"></span> ${urgencyLabel(c.age)}</td>
    <td><span class="status status-${c.status==='Ny'?'ny':c.status==='Under behandling'?'behandling':c.status==='Tilbudt'?'tilbudt':c.status==='Vunnet'?'vunnet':'tapt'}">${c.status}</span></td>
    <td class="handler">${c.handler}</td>
  </tr>`).join('');
}
function toggleFilter(btn,type) {
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); currentFilter=type; renderTable();
}
function toggleSort(s) {
  currentSort=s;
  document.getElementById('sortNewest').classList.toggle('active',s==='newest');
  document.getElementById('sortUrgent').classList.toggle('active',s==='urgent');
  renderTable();
}
function filterContracts() { searchQuery=document.getElementById('searchInput').value; renderTable(); }

function openDrawer(i) {
  const c=contracts[i];
  document.getElementById('drawerTitle').textContent=c.project;
  document.getElementById('drawerSubtitle').textContent=`${c.supplier} ‚Üí ${c.operator}`;
  document.getElementById('dDate').textContent=c.date;
  document.getElementById('dSupplier').textContent=c.supplier;
  document.getElementById('dOperator').textContent=c.operator;
  document.getElementById('dRegion').textContent=c.region;
  document.getElementById('dCountry').textContent=c.country;
  document.getElementById('dType').textContent=c.type.toUpperCase();
  document.getElementById('drawerOverlay').classList.add('open');
  document.getElementById('drawer').classList.add('open');
}
function closeDrawer() {
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('drawer').classList.remove('open');
}
function setLang(lang,btn) {
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

// DEPTH CHART
(function(){
  const depths=['0-50m','50-100','100-200','200-500','500-800','800-1000','1-1.2k','1.2-1.5k','1.5-2k','2-2.5k','2.5-3k','3k+'];
  const vals=[8,14,22,35,28,19,24,18,12,9,5,3];
  const max=Math.max(...vals);
  const colors=['#b5e8d9','#7dd4bf','#4db89e','#38917f','#2d7368','#245a4e','#1a3c34','#163029','#122822','#0e2620','#0b1e1a','#081614'];
  document.getElementById('depthChart').innerHTML=depths.map((d,i)=>`<div class="depth-bar" style="height:${vals[i]/max*120}px;background:${colors[i]}"><div class="depth-value">${vals[i]}</div><div class="depth-label">${d}</div></div>`).join('');
})();

// TIMELINE
(function(){
  const months=['Jul','Aug','Sep','Okt','Nov','Des','Jan','Feb'];
  const counts=[3,5,4,7,6,8,4,2];
  document.getElementById('timeline').innerHTML=months.map((m,i)=>`<div class="timeline-month"><div class="month-label">${m}</div><div class="timeline-dot ${counts[i]===0?'empty':''}"></div><div class="timeline-count">${counts[i]} tildelinger</div></div>`).join('');
})();

// NEWS
(function(){
  const news=[
    {title:'Equinor tildeler Irpa-kontrakt til Subsea7 ‚Äî verdt $1.2 mrd',src:'Upstream',date:'12. feb 2026',tag:'high'},
    {title:'TechnipFMC melder rekordstor ordrebok for Q4 2025',src:'Reuters',date:'10. feb 2026',tag:'med'},
    {title:'Petrobras akselererer B√∫zios-utbygging med 3 nye FPSO-er',src:'OE Digital',date:'8. feb 2026',tag:'high'},
    {title:'Saipem vinner $800M EPCI-kontrakt i Vest-Afrika',src:'TradeWinds',date:'5. feb 2026',tag:'high'},
    {title:'Subsea-markedet ventes √• vokse 12% √•rlig til 2030 (Rystad)',src:'Rystad Energy',date:'1. feb 2026',tag:'med'},
    {title:'Aker Solutions og Subsea7 danner ny allianse for nordisk shelf',src:'TU',date:'28. jan 2026',tag:'med'},
  ];
  document.getElementById('newsFeed').innerHTML=news.map(n=>`<div class="news-item"><span class="news-tag news-tag-${n.tag}">${n.tag==='high'?'H√∏y':'Medium'}</span><div class="news-content"><div class="news-title">${n.title}</div><div class="news-meta">${n.src} ¬∑ ${n.date}</div></div></div>`).join('');
})();

// FORECAST
(function(){
  const years=['2024','2025','2026','2027','2028','2029','2030','2031','2032','2033','2034'];
  const vals=[42,48,55,61,68,72,78,82,88,91,97];
  const max=Math.max(...vals);
  document.getElementById('forecastChart').innerHTML=years.map((y,i)=>`<div class="forecast-bar" style="height:${vals[i]/max*120}px;background:${i<=1?'var(--green-700)':i<=2?'var(--green-600)':'linear-gradient(180deg,var(--green-400),var(--green-300))'}"><div class="f-value">${vals[i]}B</div><div class="f-label">${y}</div></div>`).join('');
})();

// DROP ZONE
const dz=document.getElementById('dropZone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('dragover');});
dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('dragover');dz.innerHTML='<div class="drop-icon">‚úÖ</div><div class="drop-text">Dokument mottatt!</div><div class="drop-sub">AI-analyse starter...</div>';});

function setDrawerStatus(btn,status) {
  document.querySelectorAll('.drawer-status-btn').forEach(b=>{
    b.style.border='2px solid var(--border)';b.style.background='#fff';b.style.color='var(--text)';
    b.textContent=b.textContent.replace('üü¢ ','');
  });
  btn.style.border='2px solid var(--green-600)';btn.style.background='var(--green-100)';btn.style.color='var(--green-800)';
  if(status==='Under behandling') btn.textContent='üü¢ Under behandling';
  const handlerEl=document.getElementById('drawerHandler');
  handlerEl.style.display=status==='Under behandling'?'block':'none';
}

renderTable();

// ===== LEAFLET MAP =====
const COUNTRY_COORDS = {
  'Australia':[-25,134],'Angola':[-12.5,18.5],'Brazil':[-14,-51],'Brasil':[-14,-51],'Norway':[62,10],'Norge':[62,10],
  'UK':[55,-3],'USA':[37,-95],'Qatar':[25.3,51.2],'Saudi Arabia':[24,45],'UAE':[24,54],'Nigeria':[10,8],
  'Ghana':[7.9,-1.0],'Mozambique':[-18.7,35.5],'Mosambik':[-18.7,35.5],'Egypt':[27,30],'India':[20.6,79],
  'Malaysia':[4.2,101.9],'Indonesia':[-0.8,113.9],'Mexico':[23,-102],'Trinidad':[10.4,-61.3],
  'Guyana':[4.9,-58.9],'Canada':[56,-106],'Italy':[42.5,12.5],'Turkey':[39,35],'Oman':[21,57],
  'Kuwait':[29.3,47.5],'Azerbaijan':[40.1,47.6],'Aserbajdsjan':[40.1,47.6],'Senegal':[14.5,-14.5],
  'Ivory Coast':[7.5,-5.5],"Cote d'Ivoire":[7.5,-5.5],'Suriname':[4,-56],'Argentina':[-38.4,-63.6],'China':[35,105],
  'Thailand':[15.9,100.9],'Vietnam':[14,108],'Philippines':[13,122],'Myanmar':[19.7,96.2],
  'United States':[37,-95],'United Kingdom':[55,-3],'Turkiye':[39,35],'Congo':[-4.3,15.3],
  'Falkland Islands (Malvinas)':[-51.8,-59.5],'Gabon':[-0.8,11.6],'Ireland':[53.1,-7.7],
  'Mauritania':[18,-12],'Namibia':[-22.6,17],'Romania':[45.9,24.9],'Russia':[61,105],
};
const leafletMap = L.map('leafletMap',{scrollWheelZoom:true,zoomControl:true}).setView([20,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains:'abcd',maxZoom:19
}).addTo(leafletMap);
let mapMarkers = L.layerGroup().addTo(leafletMap);

function populateMapMarkers(countryData) {
  mapMarkers.clearLayers();
  if (!countryData || !countryData.length) return;
  const maxCount = Math.max(...countryData.map(c => c.count || 0), 1);
  countryData.forEach(entry => {
    const name = entry.country || entry.name || '';
    const coords = COUNTRY_COORDS[name];
    if (!coords) return;
    const count = entry.count || 0;
    const radius = Math.max(6, Math.sqrt(count / maxCount) * 30);
    L.circleMarker(coords, {
      radius: radius, fillColor:'#2d7368', color:'#1a3c34', weight:1.5, opacity:0.9, fillOpacity:0.55
    }).bindPopup(`<strong>${name}</strong><br>${count} prosjekter`).addTo(mapMarkers);
  });
}

// ===== LIVE DATA FETCHING =====
(async function loadRealData() {
  const fetchJSON = url => fetch(url, { credentials: 'include' }).then(r => r.ok ? r.json() : null).catch(() => null);

  const [stats, charts, companies, projects] = await Promise.all([
    fetchJSON('/api/dashboard/stats'),
    fetchJSON('/api/dashboard/charts'),
    fetchJSON('/api/dashboard/companies'),
    fetchJSON('/api/dashboard/projects'),
  ]);

  // === KPI CARDS ===
  if (stats) {
    const kpis = document.querySelectorAll('.kpi');
    const kpiMap = [
      { label: 'Aktive kontrakter', value: stats.totalProjects ?? '‚Äî', change: '' },
      { label: 'Total SURF km', value: (stats.totalSurfKm ?? 0) + ' km', change: '' },
      { label: 'Nye siste 30d', value: stats.upcomingAwards ?? '‚Äî', change: '' },
      { label: 'Totale XMTs', value: stats.totalXmts ?? '‚Äî', change: '' },
      { label: 'Regioner', value: stats.regionCount ?? '‚Äî', change: '' },
    ];
    kpiMap.forEach((k, i) => {
      if (kpis[i]) {
        kpis[i].querySelector('.kpi-label').textContent = k.label;
        kpis[i].querySelector('.kpi-value').textContent = k.value;
        kpis[i].querySelector('.kpi-change').textContent = k.change;
      }
    });
  }

  // === CHARTS: Regional donut ===
  if (charts && charts.byCountry) {
    const regionDonut = document.querySelectorAll('.visual-overview .card')[1];
    if (regionDonut) {
      const entries = charts.byCountry.slice(0, 5);
      const total = entries.reduce((s, e) => s + (e.count || 0), 0);
      const circumference = 2 * Math.PI * 60; // ~377
      const colors = ['var(--green-800)', 'var(--green-500)', 'var(--green-300)', 'var(--gold)', 'var(--gold-light)'];
      let offset = 0;
      let circles = `<circle cx="80" cy="80" r="60" fill="none" stroke="var(--green-100)" stroke-width="24"/>`;
      let legend = '';
      entries.forEach((e, i) => {
        const pct = total > 0 ? e.count / total : 0;
        const len = pct * circumference;
        circles += `<circle cx="80" cy="80" r="60" fill="none" stroke="${colors[i]}" stroke-width="24"
          stroke-dasharray="${len.toFixed(1)} ${(circumference - len).toFixed(1)}" stroke-dashoffset="${(-offset).toFixed(1)}" transform="rotate(-90 80 80)"/>`;
        offset += len;
        legend += `<div class="donut-legend-item"><div class="donut-legend-color" style="background:${colors[i]}"></div>${e.country || e.name}<span class="donut-legend-value">${total > 0 ? Math.round(pct * 100) : 0}%</span></div>`;
      });
      circles += `<text x="80" y="76" text-anchor="middle" font-family="IBM Plex Mono" font-size="18" font-weight="600" fill="var(--green-800)">${entries.length}</text>`;
      circles += `<text x="80" y="94" text-anchor="middle" font-family="Source Sans 3" font-size="10" fill="var(--text-secondary)">REGIONER</text>`;
      const svg = regionDonut.querySelector('.donut-svg');
      if (svg) svg.innerHTML = circles;
      const leg = regionDonut.querySelector('.donut-legend');
      if (leg) leg.innerHTML = legend || '<div>Ingen data</div>';
    }
  }

  // === MAP MARKERS ===
  if (charts && charts.byCountry) {
    populateMapMarkers(charts.byCountry);
  }

  // === COMPANY CARDS: Contractors (Installasjonsselskaper) ===
  if (companies) {
    const contractors = companies.contractors || companies.surfContractors || [];
    const contractorGrid = document.querySelector('.company-grid-primary');
    if (contractorGrid && contractors.length > 0) {
      const maxCount = Math.max(...contractors.map(c => c.count || 0), 1);
      contractorGrid.innerHTML = contractors.map(c => `
        <div class="company-card company-card-primary">
          <div class="company-name">${c.name}</div>
          <div class="company-count">${c.count || 0}</div>
          <div class="company-label">kontrakter</div>
          <div class="company-bar"><div class="company-bar-fill" style="width:${((c.count || 0) / maxCount * 100).toFixed(0)}%"></div></div>
        </div>
      `).join('');
      // Update badge
      const badge = contractorGrid.closest('.card')?.querySelector('.section-badge');
      if (badge) badge.textContent = contractors.length + ' selskaper';
    }

    // Operators
    const operators = companies.operators || [];
    const operatorGrid = document.querySelector('.company-grid-tertiary');
    if (operatorGrid && operators.length > 0) {
      operatorGrid.innerHTML = operators.map(o => `
        <div class="company-card company-card-tertiary">
          <span class="company-name">${o.name}</span>
          <span class="company-count">${o.count || 0}</span>
        </div>
      `).join('');
    }
  }

  // === PROJECT TABLE ===
  if (projects && Array.isArray(projects) && projects.length > 0) {
    // Replace the contracts array and re-render
    contracts.length = 0;
    projects.forEach(p => {
      contracts.push({
        date: p.award_date || p.created_at || '‚Äî',
        supplier: p.surf_contractor || '‚Äî',
        operator: p.operator || '‚Äî',
        project: p.development_project || p.name || '‚Äî',
        relevance: 'med',
        region: p.country || '‚Äî',
        country: p.country || '‚Äî',
        type: 'subsea',
        age: 0,
        status: 'Ny',
        handler: '‚Äî',
        waterDepth: p.water_depth || '‚Äî',
        xmts: p.xmts || 0,
        surfKm: p.surf_km || 0,
      });
    });

    // Update table headers for project data
    const thead = document.querySelector('.card.full-width table thead tr');
    if (thead) {
      thead.innerHTML = `
        <th>Prosjekt</th>
        <th>Land</th>
        <th>Operat√∏r</th>
        <th>SURF Contractor</th>
        <th>Vanndybde</th>
        <th>XMTs</th>
        <th>SURF km</th>
      `;
    }

    // Override renderTable for new columns
    const origRender = renderTable;
    window.renderTable = function() {
      let data = [...contracts];
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        data = data.filter(c => Object.values(c).some(v => String(v).toLowerCase().includes(q)));
      }
      const tb = document.getElementById('contractTable');
      tb.innerHTML = data.map((c, i) => `<tr onclick="openDrawer(${i})">
        <td><strong>${c.project}</strong></td>
        <td>${c.country}</td>
        <td>${c.operator}</td>
        <td>${c.supplier}</td>
        <td class="mono">${c.waterDepth}</td>
        <td class="mono">${c.xmts}</td>
        <td class="mono">${c.surfKm}</td>
      </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--text-secondary)">Ingen data</td></tr>';
    };
    renderTable();
  }

})();
</script>
</body>
</html>
